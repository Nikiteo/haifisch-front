name: ğŸš€ Deploy Frontend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: ğŸ› ï¸ Build & Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
    # ======================
    # 1. Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
    # ======================
    - name: "â–›â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–œ"
      run: echo "â–ŒğŸš€ Starting deployment process â–Œ"

    - name: Show ASCII banner
      run: |
        echo "  _____ _____ _____ _____ _____ _____ _____ _____  "
        echo " |  _  |  |  |   __|     |   __|  _  |     |   __| "
        echo " |   __|  |  |  |  |  |  |  |  |     | | | |   __| "
        echo " |__|  |_____|_____|_____|_____|__|__|_|_|_|_____| "
        echo "                  DEPLOYMENT v1.0                   "

    # ======================
    # 2. ĞŸĞĞ”Ğ“ĞĞ¢ĞĞ’ĞšĞ
    # ======================
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    # ======================
    # 3. Ğ¡Ğ‘ĞĞ ĞšĞ
    # ======================
    - name: Install dependencies
      run: |
        echo "::group::ğŸ“¦ Installing dependencies"
        npm ci
        echo "::endgroup::"
        echo "::notice::Dependencies installed successfully"

    - name: Build project
      run: |
        echo "::group::ğŸ”¨ Running build"
        npm run build
        echo "BUILD_DATE=$(date +'%Y.%m.%d-%H:%M')" >> $GITHUB_ENV
        echo "::endgroup::"
        echo "::notice title=Build::Production build completed"

    # ======================
    # 4. Ğ”Ğ•ĞŸĞ›ĞĞ™
    # ======================
    - name: Prepare deployment
      run: |
        echo "::group::ğŸ“¡ Connecting to VM"
        echo "Target: 87.242.119.108"
        echo "User: nikiteo"
        echo "::endgroup::"

    - name: Clean remote dist
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: 87.242.119.108
        username: nikiteo
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ~/haifisch-front
          rm -rf dist
          echo "ğŸ—‘ï¸ Old dist folder removed"

    - name: Upload new build
      uses: appleboy/scp-action@v0.1.4
      with:
        host: 87.242.119.108
        username: nikiteo
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "dist/"
        target: "~/haifisch-front/"
        strip_components: 1

    # ======================
    # 5. Ğ£Ğ’Ğ•Ğ”ĞĞœĞ›Ğ•ĞĞ˜Ğ¯
    # ======================
    - name: Telegram notification
      uses: appleboy/telegram-action@v1.0.1
      if: always()
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          *${{ job.status == 'success' && 'âœ… DEPLOY SUCCESS' || 'âŒ DEPLOY FAILED' }}*
          ==================
          *Project*: ${{ github.repository }}
          *Branch*: ${{ github.ref_name }}
          *Version*: ${{ env.BUILD_DATE }}
          *Commit*: `${{ github.sha }}`
          ==================
          [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        format: markdown

    # ======================
    # 6. ĞĞ¢Ğ§ĞĞ¢
    # ======================
    - name: Create summary
      if: always()
      run: |
        echo "### ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status | Time |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Setup | âœ… Success | $(date +'%T') |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | âœ… Success | $(date +'%T') |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy | ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }} | $(date +'%T') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build version:** ${{ env.BUILD_DATE }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "![Deploy](https://media.giphy.com/media/3o7TKSjRrfIPjeiVyM/giphy.gif)" >> $GITHUB_STEP_SUMMARY

    - name: "â–™â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–Ÿ"
      if: always()
      run: echo "â–ŒğŸ Deployment ${{ job.status }} â–Œ"